#!/bin/sh

fixperms(){
  find . \( -name "*.sh" -or -type d \) -exec chmod 755 {} \; && find . -type f ! -name "*.sh" -exec chmod 644 {} \;
}

showdf() {
  defaults write com.apple.Finder AppleShowAllFiles YES
  osascript -e 'tell application "Finder" to quit'
  sleep 0.25
  osascript -e 'tell application "Finder" to activate'
}

hidedf() {
  defaults write com.apple.Finder AppleShowAllFiles NO
  osascript -e 'tell application "Finder" to quit'
  sleep 0.25
  osascript -e 'tell application "Finder" to activate'
}

init_ipykernel () {
  echo "Setting up pipenv environment"
  echo "Installing ipython kernel"
  pipenv install --dev ipykernel
  # get name of environment and remove checksum for pretty name
  venv_name=$(basename -- "$(pipenv --venv)")
  venv_prettyname=$(echo "$venv_name" | cut -d '-' -f 1)
  echo "Adding ipython kernel to list of jupyter kernels"
  $(pipenv --py) -m ipykernel install --name "$venv_name" \
  --display-name "Python3 ($venv_prettyname)"
}

# https://github.com/nix-community/nix-direnv/wiki/Shell-integration
nixify() {
  if [ ! -e ./.envrc ]; then
    echo "use nix" > .envrc
    direnv allow
  fi
  if [[ ! -e shell.nix ]] && [[ ! -e default.nix ]]; then
    cat > default.nix <<'EOF'
      with import <nixpkgs> {};
      mkShell {
        nativeBuildInputs = [
          bashInteractive
        ];
      }
EOF
    ${EDITOR:-vim} default.nix
  fi
}

flakify() {
  if [ ! -e flake.nix ]; then
    nix flake new -t github:nix-community/nix-direnv .
  elif [ ! -e .envrc ]; then
    echo "use flake" > .envrc
    direnv allow
  fi
  ${EDITOR:-nvim} flake.nix
}

git_get_all_blob() {
  git rev-list --objects --all |
  git cat-file --batch-check='%(objecttype) %(objectname) %(objectsize) %(rest)' |
  sed -n 's/^blob //p' |
  sort --numeric-sort --key=2 |
  cut -c 1-12,41- |
  $(command -v gnumfmt || echo numfmt) --field=2 --to=iec-i --suffix=B --padding=7 --round=nearest
}

# Fabric AI patterns integration
# Function to list all available Fabric patterns
list_fabric_patterns() {
  if [ -d "$HOME/.config/fabric/patterns" ]; then
    echo "Available Fabric patterns:"
    ls -1 "$HOME/.config/fabric/patterns" | sed 's/^/  â€¢ /'
    echo ""
    echo "Usage:"
    echo "  pattern_name       - Run pattern and display output"
    echo "  f_pattern_name     - Run pattern and save to Obsidian markdown"
  else
    echo "Fabric patterns not found. Run 'fabric --setup' first."
  fi
}

# Function to create Fabric pattern aliases statically to a file
create_fabric_aliases() {
  local alias_file="$HOME/.config/fabric/fabric_aliases.zsh"
  mkdir -p "$HOME/.config/fabric"
  echo "# Auto-generated Fabric aliases by Home Manager" > "$alias_file"
  if [ -d "$HOME/.config/fabric/patterns" ]; then
    for pattern in "$HOME/.config/fabric/patterns"/*; do
      if [ -d "$pattern" ]; then
        local pattern_name=$(basename "$pattern")
        echo "alias \"f_$pattern_name\"='fabric --pattern \"$pattern_name\" | tee \"\$OBSIDIAN_PATH/fabric-$pattern_name-\$(date +%Y%m%d-%H%M%S).md\"'" >> "$alias_file"
        echo "alias \"$pattern_name\"='fabric --pattern \"$pattern_name\"'" >> "$alias_file"
      fi
    done
  fi
}
